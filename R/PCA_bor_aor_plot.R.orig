if(!require(optparse)){
  install.packages('optparse')
}
require(data.table)
require(ggplot2)
require(ggbiplot)


option_list = list(
  make_option(c("-f", "--file"), action="store", default=NA, type='character',
              help="coding genes output file"),
  make_option(c("-o", "--output.folder"), action="store", default=NA, type='character',
              help="The output file")
)
opt = parse_args(OptionParser(option_list=option_list))

#https://www.r-bloggers.com/detecting-outlier-samples-in-pca/
robust.outlier<-function(x) which( (abs(x - median(x)) / mad(x)) > 6 )
explained.variance<-function(x) cumsum(pca$sdev^2/sum(pca$sdev^2))
which.perc<-function(x, perc) min(which(x>=perc))

#Read and log transform data
opt$f<-'/home/anne/Documents/featurecloud/data/tcga/data_clean/TARGET-ALL-P2/coding_only.tsv'
data<-fread(file = opt$f)
var0<-which(apply(data,1, function(x) var(x)==0))
data<-data[, c(which(colSums(data)!=0), var0), with=F]
data<-log2(data+1)

#run first PCA
pca<-prcomp(data, center = T, scale. = T)
ou<-as.numeric(unlist(apply(pca$x[,1:3], 2, function(x) robust.outlier(x))))

if(length(ou)>0){
groups <- rep('regular', nrow(data))
groups[ou]<-'outlier'
}else{
  groups <- rep('regular', nrow(data))
}

p<-ggbiplot(pca, var.axes = F, labels = 1:nrow(data), groups = as.factor(groups))
file.name<-paste0(basename(dirname(opt$f)), '.pdf')
ggsave(p, filename = file.path(opt$o, file.name))

var60.pca<-which.perc(explained.variance(pca$sdev), 0.6)

#Remove outlier and rerun.
if(length(ou)!=0){
outlier.free<-data[-ou]
lab<-1:nrow(data)
<<<<<<< HEAD
lab<-lab[-ou]
}else{
  outlier.free<-data
lab<-1:nrow(data)
=======
lab<- lab[-ou]
}else{
  outlier.free<-data
  lab<-1:nrow(data)
>>>>>>> abad6772d682de1da881ea242acb6e060df41f67
}
var0<-which(apply(outlier.free,1, function(x) var(x)==0))
outlier.free<-outlier.free[, c(which(colSums(outlier.free)!=0), var0), with=F] 
pca.outlier.free<-prcomp(outlier.free, scale. = T, center = T)
<<<<<<< HEAD
p.out<-ggbiplot(pca.outlier.free, var.axes = F, labels = lab)
#p.out
=======

p.out<-ggbiplot(pca.outlier.free, var.axes = F, labels = lab)
>>>>>>> abad6772d682de1da881ea242acb6e060df41f67
file.name.out<-paste0(basename(dirname(opt$f)),'_outlier_free', '.pdf')
ggsave(p.out, filename = file.path(opt$o, file.name.out))

var60.pca.aor<-which.perc(explained.variance(pca.outlier.free$sdev), 0.6)
line<-paste(c(basename(dirname(opt$f)), length(ou), var60.pca, var60.pca.aor, ou), collapse  = '\t')
write(line,file=file.path(opt$o, 'summary.txt'),append=TRUE)


# mahalanobis distance as such not suited for a n<<<d problem.
# dist<-covrob_ogk(pca$x)
# pchisq(dist$center, df = 10, lower.tail = FALSE)

